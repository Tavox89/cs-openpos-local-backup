<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>CSFX – Cierre diario</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{font:14px system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:20px}
  header{display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
  button{padding:8px 14px;border:0;border-radius:999px;font-weight:600;cursor:pointer;transition:transform .15s ease, box-shadow .15s ease;box-shadow:0 4px 12px rgba(0,0,0,.08)}
  button:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.12)}
  #open{background:#2563eb;color:#fff}
  #export{background:#0f9b69;color:#fff}
  #print{background:#374151;color:#fff}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:top}
  th{background:#f5f5f5}
  .muted{opacity:.7}
  #orders{display:flex;flex-direction:column;gap:24px;margin-top:16px}
  .cashier-block{border:1px solid #ccc;border-radius:8px;padding:16px;background:#fff}
  .cashier-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px}
  .cashier-header h3{margin:0;font-size:16px}
  .list-table{width:100%;border-collapse:collapse;margin-top:8px}
  .list-table th,.list-table td{border:1px solid #e1e1e1;padding:6px 8px;font-size:13px}
  .list-table th{background:#fafafa;text-transform:uppercase;font-size:11px;letter-spacing:.04em}
  .status-pill{display:inline-flex;align-items:center;padding:2px 10px;border-radius:999px;font-size:12px;text-transform:capitalize;border:1px solid rgba(244,191,64,.45);background:#fff8e1;color:#9c6b00}
  .status-pill.pending{background:#fff8e1;color:#9c6b00;border-color:rgba(244,191,64,.45)}
  .status-pill.verificado{background:#e6f9ee;color:#0b8c52;border-color:rgba(25,135,84,.35)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:#eef;border-radius:999px;font-size:12px;color:#334}
  .cashier-summary{margin-top:8px;padding:6px 12px;background:#f4f8ff;border-radius:8px;font-size:13px;color:#264a8a;display:flex;flex-wrap:wrap;gap:8px}
  .cashier-summary strong{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:#1e3a8a}
  .summary-grid{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px}
  .summary-card{flex:1 1 180px;background:#111;color:#fff;border-radius:12px;padding:12px 16px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
  .summary-label{display:block;font-size:12px;opacity:.7;text-transform:uppercase;letter-spacing:.08em}
  .summary-value{display:flex;flex-wrap:wrap;gap:6px;font-size:20px;margin:6px 0;font-weight:600;align-items:baseline}
  .summary-value > span{display:inline-block}
  .summary-digit{font-size:28px}
  .summary-hint{display:block;font-size:12px;opacity:.6}
  .summary-bar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;background:#f9fbff;border:1px solid #e0e8ff;border-radius:10px;padding:10px 14px;margin-bottom:16px}
  .summary-bar > div{font-size:13px;color:#264a8a;display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .summary-bar > div > strong{margin-right:6px}
  .summary-chip{display:inline-block;background:#fff;color:#111;padding:2px 10px;border-radius:999px;font-size:12px;margin:2px 4px 2px 0;border:1px solid rgba(17,24,39,.08)}
  .summary-bar .action-generate{margin-left:auto}
  .action-btn.action-generate{background:#f97316;color:#fff}
  .payments-wrap{display:flex;flex-wrap:wrap;gap:6px}
  .payments-summary{display:flex;flex-wrap:wrap;gap:6px}
  .pay-pill{display:inline-flex;align-items:center;background:#eef;padding:4px 10px;border-radius:999px;margin:0;font-size:12px;line-height:1.3;border:1px solid rgba(99,102,241,.2)}
  .pay-pill strong{font-weight:600;margin-right:6px}
  .pay-pill span{display:block;color:#1f2937;font-weight:500}
  .pay-pill small{display:block;font-size:11px;color:#334;opacity:.75;margin-left:4px}
  .action-btn{padding:6px 12px;border:0;border-radius:999px;background:#2563eb;color:#fff;cursor:pointer;font-size:12px;box-shadow:0 4px 12px rgba(37,99,235,.2);transition:transform .15s ease, box-shadow .15s ease}
  .action-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(37,99,235,.24)}
  .action-btn.btn-view{background:#0ea5e9}
  .action-btn.btn-verify{background:#f59e0b}
  .action-btn.btn-verify:hover{box-shadow:0 6px 18px rgba(245,158,11,.24)}
  .action-btn.btn-view:hover{box-shadow:0 6px 18px rgba(14,165,233,.24)}
  .actions-cell{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
  .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
  .info-card{background:#f7f9ff;border-radius:10px;padding:10px 12px;box-shadow:0 1px 3px rgba(15,23,42,.08)}
  .info-label{display:block;font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:#64748b;margin-bottom:6px}
  .info-value{font-size:14px;font-weight:600;color:#0f172a}
  .raw-block{margin-top:8px;background:#0f172a;color:#f8fafc;border-radius:10px;overflow:hidden}
  .raw-block summary{cursor:pointer;padding:10px 14px;background:#1e293b;color:#fff;font-weight:600;outline:none}
  .raw-block[open]{box-shadow:0 10px 25px rgba(15,23,42,.3)}
  .raw-block pre{margin:0;padding:12px 16px;font-size:12px;background:#0f172a;color:#e2e8f0;max-height:260px;overflow:auto}
  #detail{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:rgba(0,0,0,.45)}
  #detail[hidden]{display:none}
  .detail-card{background:#fff;width:min(90vw,900px);max-height:90vh;border-radius:10px;overflow:auto;box-shadow:0 12px 40px rgba(0,0,0,.35);display:flex;flex-direction:column}
  .detail-card header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #eee;background:#111;color:#fff}
  .detail-card h2{margin:0;font-size:18px}
  #detail-close{border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#f5f5f5}
  #detail-close:hover{color:#93c5fd}
  .detail-content{padding:16px;display:flex;flex-direction:column;gap:16px}
  .detail-content section{background:#f8fafc;border:1px solid #e2e8ff;border-radius:12px;padding:12px}
  .detail-content h3{margin:0 0 8px;font-size:14px;color:#1e293b;text-transform:uppercase;letter-spacing:.06em}
  .detail-content table{width:100%;border-collapse:collapse}
  .detail-content table th,.detail-content table td{border:1px solid #e2e8ff;padding:6px 8px;font-size:13px}
  .detail-content table th{background:#eef2ff;text-transform:uppercase;font-size:11px;letter-spacing:.06em;color:#1e293b}
  #detail-totals{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;font-size:13px;margin-top:6px}
  #detail-totals dt{font-weight:600;font-size:11px;text-transform:uppercase;color:#64748b}
  #detail-totals dd{margin:4px 0 0;color:#0f172a;font-weight:600;font-size:14px}
</style>
</head>
<body>
<header>
  <button id="open">Seleccionar carpeta (día)</button>
  <button id="export" disabled>Descargar CSV</button>
  <button id="print" disabled>Imprimir</button>
  <span id="info" class="muted"></span>
</header>

<section id="summary"></section>
<section id="orders"></section>

<div id="detail" hidden>
  <div class="detail-backdrop"></div>
  <div class="detail-card" role="dialog" aria-modal="true">
    <header>
      <h2>Detalle del pedido</h2>
      <button type="button" id="detail-close" aria-label="Cerrar">×</button>
    </header>
    <div class="detail-content">
      <section>
        <h3>Información general</h3>
        <div id="detail-info" class="info-grid"></div>
      </section>
      <section>
        <h3>Productos</h3>
        <table id="detail-items"><thead><tr><th>Producto</th><th>Código</th><th>Cantidad</th><th>Precio</th><th>Descuento</th><th>Total</th></tr></thead><tbody></tbody></table>
      </section>
      <section>
        <h3>Pagos</h3>
        <table id="detail-payments"><thead><tr><th>Método</th><th>Monto</th><th>Vuelto</th><th>Referencia</th><th>Tipo</th></tr></thead><tbody></tbody></table>
      </section>
      <section>
        <h3>Totales</h3>
        <dl id="detail-totals"></dl>
      </section>
      <details class="raw-block">
        <summary>Datos crudos</summary>
        <pre id="detail-raw"></pre>
      </details>
    </div>
  </div>
</div>

<script>
(async function(){
  const $ = s=>document.querySelector(s);
  let folder=null;
  let orders=[];

  const toAmount = value => {
    if (value == null || value === '') return 0;
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
      const normalized = value.replace(/[^0-9,.-]/g, '').replace(',', '.');
      const num = parseFloat(normalized);
      return isNaN(num) ? 0 : num;
    }
    const num = Number(value);
    return isNaN(num) ? 0 : num;
  };

  const fmtMoney = (amount, formatted) => {
    if (formatted && formatted.trim) return formatted.trim();
    if (amount == null || amount === '') return '';
    const num = Number(amount);
    return isNaN(num) ? String(amount) : num.toLocaleString('es-VE', {minimumFractionDigits:2, maximumFractionDigits:2});
  };

  let DEFAULT_CASHIER = '';
  try {
    DEFAULT_CASHIER = (localStorage.getItem('csfx_lb_staff_login') || '').trim();
  } catch (err) {
    DEFAULT_CASHIER = '';
  }

  function normalizeCashierName(name, registerName) {
    const candidate = (name || '').toString().trim();
    const register = (registerName || '').toString().trim();
    if (candidate && register && candidate.toLowerCase() === register.toLowerCase()) {
      return DEFAULT_CASHIER || candidate;
    }
    if (!candidate) {
      return DEFAULT_CASHIER || register || 'Sin cajero';
    }
    return candidate;
  }

  function safe(value){
    if (value == null || value === '') return '—';
    return String(value);
  }

  function paymentsFrom(orderData, rawDoc){
    const map = new Map();

    const upsert = (codeRaw, labelRaw)=>{
      const key = (codeRaw || labelRaw || 'pago').toString().toLowerCase();
      if (!map.has(key)) {
        map.set(key, {
          code: codeRaw || labelRaw || key,
          label: labelRaw || codeRaw || 'Pago',
          amount: 0,
          display: '0,00',
          change: 0,
          changeDisplay: '0,00',
          reference: '',
          type: ''
        });
      }
      return map.get(key);
    };

    const applyPayment = (p)=>{
      if(!p) return;
      const code = p.code || p.payment_code || p.method || p.payment_name || p.name || p.title || '';
      const label = p.name || p.payment_name || p.method || p.title || code || 'Pago';
      const amount = toAmount(p.paid ?? p.total ?? p.amount ?? p.in_amount ?? p.paid_amount ?? 0);
      const change = toAmount(p.change ?? p.return ?? p.change_amount ?? p.return_amount ?? 0);
      const formatted = p.paid_currency_formatted || p.total_currency_formatted || p.amount_currency_formatted || p.in_amount_currency_formatted;
      const entry = upsert(code, label);
      entry.amount += amount;
      entry.change += change;
      entry.display = fmtMoney(entry.amount);
      entry.changeDisplay = fmtMoney(entry.change);
      if (!entry.reference && (p.payment_ref || p.ref || p.reference || p.transaction_reference)) {
        entry.reference = p.payment_ref || p.ref || p.reference || p.transaction_reference || '';
      }
      if (!entry.type && (p.type || p.offline_transaction || p.mode || p.transaction_type)) {
        entry.type = p.type || p.offline_transaction || p.mode || p.transaction_type || '';
      }
    };

    if (Array.isArray(orderData?.payment_method)) {
      orderData.payment_method.forEach(applyPayment);
    }
    if (Array.isArray(rawDoc?.payments)) {
      rawDoc.payments.forEach(applyPayment);
    }

    const trans = orderData?.transactions;
    const mergeTransaction = (p)=>{
      if(!p) return;
      applyPayment(p);
    };
    if (Array.isArray(trans)) trans.forEach(mergeTransaction);
    else if (trans && typeof trans === 'object') {
      Object.values(trans).forEach(mergeTransaction);
    }

    return [...map.values()];
  }

  function getCustomerName(orderData, docCustomer){
    const fromOrder = orderData?.customer;
    const candidates = [
      fromOrder?.name,
      [fromOrder?.firstname, fromOrder?.lastname].filter(Boolean).join(' ').trim(),
      docCustomer?.name,
      [docCustomer?.firstname, docCustomer?.lastname].filter(Boolean).join(' ').trim()
    ].filter(v=>v && v.length);
    return candidates[0] || 'Sin cliente';
  }

  function normalizeOrder(doc){
    const orderData = doc.orderData || {};
    const registerName = orderData.register?.name || doc.registerName || '—';
    let cashier =
      orderData.user?.username ||
      orderData.user?.user_login ||
      orderData.sale_person_username ||
      orderData.sale_person_name ||
      orderData.salesperson ||
      orderData.cashier ||
      doc.cashier ||
      doc.cart?.cashier ||
      doc.cart?.salesperson ||
      '';
    cashier = normalizeCashierName(cashier, registerName);
    if (doc && typeof doc === 'object') {
      if (doc.cashier !== cashier) doc.cashier = cashier;
      if (doc.cart && typeof doc.cart === 'object') {
        doc.cart.cashier = doc.cart.cashier || cashier;
        doc.cart.salesperson = doc.cart.salesperson || cashier;
      }
    }
    const orderNumber = doc.orderNumber || orderData.order_number || orderData.order_number_format || (orderData.order_number_details && orderData.order_number_details.order_number) || doc.key;
    const orderId = doc.orderId || orderData.order_id || orderData.id || null;
    const rawTotals = doc.totals || orderData.totals || {};
    const totalsData = rawTotals && typeof rawTotals === 'object' ? {...rawTotals} : {};
    if (rawTotals && typeof rawTotals === 'object' && rawTotals.currency) {
      totalsData.currency = {...rawTotals.currency};
    }
    const cartItems = Array.isArray(orderData?.items)
      ? orderData.items
      : Array.isArray(doc?.cart?.items)
        ? doc.cart.items
        : Array.isArray(doc?.cart)
          ? doc.cart
          : [];
    const payments = paymentsFrom(orderData, doc);
    const discountFromItems = cartItems.reduce((acc,it)=>{
      const value = toAmount(it.final_discount_amount ?? it.discount_amount ?? it.discount ?? 0);
      return acc + value;
    },0);
    if (totalsData.discount_amount == null) {
      totalsData.discount_amount =
        orderData.total_discount ??
        orderData.discount_amount ??
        (discountFromItems || null);
    }
    if (totalsData.currency) {
      if (!totalsData.currency.discount_amount && totalsData.discount_amount != null) {
        totalsData.currency.discount_amount = fmtMoney(totalsData.discount_amount);
      }
    }
    let totalValue = totalsData?.grand_total ?? orderData.grand_total ?? totalsData?.total ?? orderData.total_paid ?? 0;
    if (!totalValue) {
      const paySum = Array.isArray(payments) ? payments.reduce((acc, p) => acc + (Number(p.amount) || 0), 0) : 0;
      if (paySum > 0) {
        totalValue = paySum;
      } else {
        const list = Array.isArray(orderData?.items)
          ? orderData.items
          : (Array.isArray(doc?.cart) ? doc.cart : (Array.isArray(doc?.cart?.items) ? doc.cart.items : []));
        if (list.length) {
          totalValue = list.reduce((acc, it) => acc + (Number(it.total ?? it.total_incl_tax ?? it.final_price ?? it.price) || 0), 0);
        }
      }
    }
    const total = toAmount(totalValue);
    const totalDisplay = totalsData?.currency?.grand_total
      || orderData.grand_total_currency_formatted
      || totalsData?.currency?.total_paid
      || orderData.total_paid_currency_formatted
      || fmtMoney(total);
    const discountValue = orderData.total_discount ?? orderData.discount_amount ?? totalsData?.discount_amount ?? 0;
    const discountAmount = toAmount(discountValue);
    const discountDisplay = orderData.total_discount_currency_formatted || orderData.discount_amount_currency_formatted || totalsData?.currency?.discount || fmtMoney(discountAmount);
    const customerName = getCustomerName(orderData, doc.customer);

    const createdAtCandidates = [
      doc.createdAtText,
      orderData.created_at_utc,
      orderData.created_at,
      doc.createdAt,
      orderData.created_at_ms,
      orderData.updated_at
    ];

    let createdAtDate = null;
    for (const candidate of createdAtCandidates) {
      if (candidate === undefined || candidate === null || candidate === '') continue;
      let date;
      if (candidate instanceof Date) {
        date = candidate;
      } else if (typeof candidate === 'number') {
        date = new Date(candidate);
      } else if (typeof candidate === 'string' && /^\d+$/.test(candidate)) {
        date = new Date(Number(candidate));
      } else {
        date = new Date(candidate);
      }
      if (date && !isNaN(date.getTime())) {
        createdAtDate = date;
        break;
      }
    }
    if (!createdAtDate && doc.createdAtParts) {
      const p = doc.createdAtParts;
      const iso = `${p.y || '1970'}-${p.m || '01'}-${p.d || '01'}T${p.H || '00'}:${p.M || '00'}:${p.S || '00'}Z`;
      const date = new Date(iso);
      if (!isNaN(date.getTime())) createdAtDate = date;
    }

    const createdAtISO = createdAtDate ? createdAtDate.toISOString() : (doc.createdAtText || orderData.created_at_utc || '');
    const createdAtDisplay = createdAtDate ? createdAtDate.toLocaleString('es-VE', { hour12: true }) : (createdAtISO || '—');
    const createdAtTime = createdAtDate ? createdAtDate.toLocaleTimeString('es-VE', { hour12: true }) : '—';

    const status = (doc.status || orderData.status || 'pending').toString();
    if (doc && typeof doc === 'object') {
      doc.status = status;
    }
    return {
      id: `${doc.ref || doc.key}`,
      fileName: doc.fileName,
      cashier,
      orderNumber,
      orderId,
      total,
      totalDisplay,
      discountAmount,
      discountDisplay,
      payments,
      customerName,
      createdAtISO,
      createdAtDisplay,
      createdAtTime,
      status,
      doc,
      orderData,
      registerName,
      createdAtParts: doc.createdAtParts || {},
      totals: totalsData
    };
  }

  function buildSummary(){
    const overall = {orders: orders.length, total:0, discount:0};
    const byCashier = new Map();
    const byMethod = new Map();
    const byStatus = new Map();
    orders.forEach(o=>{
      overall.total += toAmount(o.total);
      overall.discount += toAmount(o.discountAmount);
      if(!byCashier.has(o.cashier)) byCashier.set(o.cashier,{total:0,count:0});
      const info = byCashier.get(o.cashier);
      info.total += toAmount(o.total);
      info.count++;
      const st = (o.status || 'pending').toLowerCase();
      byStatus.set(st, (byStatus.get(st) || 0) + 1);
      o.payments.forEach(p=>{
        const key = p.label || 'Pago';
        const bucket = byMethod.get(key) || { amount: 0, change: 0 };
        bucket.amount += toAmount(p.amount);
        bucket.change += toAmount(p.change);
        byMethod.set(key, bucket);
      });
    });

    const cashierChips = [...byCashier.entries()].map(([name,val])=>`<span class="summary-chip">${name}: ${fmtMoney(val.total)} (${val.count})</span>`).join('') || '<span class="summary-chip">—</span>';
    const methodChips = [...byMethod.entries()].map(([m,v])=>`<span class="summary-chip">${m}: ${fmtMoney(v.amount)}${v.change > 0 ? ` (Vuelto: ${fmtMoney(v.change)})` : ''}</span>`).join('') || '<span class="summary-chip">—</span>';
    const statusChips = overall.orders ? [...byStatus.entries()].map(([s,c])=>{
      const label = s.charAt(0).toUpperCase() + s.slice(1);
      return `<span class="summary-chip">${c} ${label}</span>`;
    }).join('') : '<span class="summary-chip">—</span>';

    $('#summary').innerHTML = `
      <div class="summary-grid">
        <div class="summary-card">
          <span class="summary-label">Órdenes</span>
          <span class="summary-value"><span class="summary-digit">${overall.orders}</span></span>
          <span class="summary-hint">Total ${fmtMoney(overall.total)}</span>
        </div>
        <div class="summary-card">
          <span class="summary-label">Descuento</span>
          <span class="summary-value"><span class="summary-digit">${fmtMoney(overall.discount)}</span></span>
          <span class="summary-hint">Aplicado</span>
        </div>
        <div class="summary-card">
          <span class="summary-label">Status</span>
          <span class="summary-value">${statusChips}</span>
        </div>
      </div>
      <div class="summary-bar">
        <div><strong>Por cajero:</strong> ${cashierChips}</div>
        <div><strong>Por método:</strong> ${methodChips}</div>
        <button class="action-btn action-generate" data-id="all">Verificación general</button>
      </div>`;

    $('#export').disabled = orders.length===0;
    $('#print').disabled = orders.length===0;
  }

  function renderGroups(){
    const container = $('#orders');
    container.innerHTML='';
    const grouped = new Map();
    orders.forEach(o=>{
      if(!grouped.has(o.cashier)) grouped.set(o.cashier, []);
      grouped.get(o.cashier).push(o);
    });

    [...grouped.entries()].sort((a,b)=>a[0].localeCompare(b[0])).forEach(([cashier,list])=>{
      list.sort((a,b)=>{
        const ca = (a.createdAtParts?.H||'')+(a.createdAtParts?.M||'')+(a.createdAtParts?.S||'');
        const cb = (b.createdAtParts?.H||'')+(b.createdAtParts?.M||'')+(b.createdAtParts?.S||'');
        return ca.localeCompare(cb);
      });
      const block=document.createElement('div');
      block.className='cashier-block';
      const total = list.reduce((acc,o)=>acc+toAmount(o.total),0);
      const summaryMethods = new Map();
      list.forEach(order => {
        order.payments.forEach(p => {
          const key = p.label || 'Pago';
          const bucket = summaryMethods.get(key) || { amount: 0, change: 0 };
          bucket.amount += toAmount(p.amount);
          bucket.change += toAmount(p.change);
          summaryMethods.set(key, bucket);
        });
      });

      const methodsSummary = summaryMethods.size
        ? [...summaryMethods.entries()]
            .map(([method, val]) => `<span class="summary-chip">${method}: ${fmtMoney(val.amount)}${val.change > 0 ? ` (Vuelto: ${fmtMoney(val.change)})` : ''}</span>`)
            .join('')
        : '<span class="summary-chip">—</span>';

      block.innerHTML = `
        <div class="cashier-header">
          <h3>${cashier}</h3>
          <span class="badge">Órdenes: ${list.length} · Total: ${fmtMoney(total)}</span>
        </div>
        <div class="cashier-summary"><strong>Pagos</strong><div class="payments-summary">${methodsSummary}</div></div>`;

      const table=document.createElement('table');
      table.className='list-table';
      table.innerHTML = `<thead><tr>
        <th>Factura</th>
        <th>Cliente</th>
        <th>Total</th>
        <th>Métodos de pago</th>
        <th>Hora</th>
        <th>Status</th>
        <th>Acciones</th>
      </tr></thead>`;
      const tbody=document.createElement('tbody');
      list.forEach(o=>{
        const tr=document.createElement('tr');
        const paymentsHtml = o.payments.length
          ? `<div class="payments-wrap">${o.payments.map(p=>{
              const changeSnippet = p.change > 0 ? `<small>Vuelto: ${safe(p.changeDisplay)}</small>` : '';
              return `<span class="pay-pill"><strong>${safe(p.label)}</strong><span>${safe(p.display)}</span>${changeSnippet}</span>`;
            }).join('')}</div>`
          : '<span class="muted">—</span>';
        const createdAtLocale = o.createdAtTime || '—';
        const statusRaw = (o.status || 'pending').toString();
        const statusLabel = statusRaw.charAt(0).toUpperCase() + statusRaw.slice(1);
        const statusClass = statusRaw.toLowerCase().replace(/\s+/g,'-');
        tr.innerHTML = `
          <td>${safe(o.orderNumber)}</td>
          <td>${safe(o.customerName)}</td>
          <td>${safe(o.totalDisplay)}</td>
          <td>${paymentsHtml}</td>
          <td>${safe(createdAtLocale)}</td>
          <td><span class="status-pill ${statusClass}">${safe(statusLabel)}</span></td>
          <td class="actions-cell">
            <button class="action-btn btn-view" data-id="${o.id}" data-action="detail">Ver</button>
            <button class="action-btn btn-verify action-verify" data-id="${o.id}">Verificar</button>
          </td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      block.appendChild(table);
      container.appendChild(block);
    });
  }

  function fillDetail(order){
    const detail = $('#detail');
    const info = $('#detail-info');
    const totals = $('#detail-totals');
    const itemsTable = $('#detail-items tbody');
    const payTable = $('#detail-payments tbody');
    const raw = $('#detail-raw');

    const infoPairs = [
      ['Factura', order.orderNumber || '—'],
      ['Fecha', (order.createdAtDisplay || order.createdAt) || '—'],
      ['ID interno', order.orderId ?? '—'],
      ['Cajero', order.cashier],
      ['Caja / Registro', order.registerName || '—'],
      ['Cliente', order.customerName || 'Sin cliente'],
      ['Total', order.totalDisplay || fmtMoney(order.total)],
      ['Descuento general', order.discountDisplay || fmtMoney(order.discountAmount)],
      ['Status', order.status || 'sin sinc.'],
      ['Nota', order.orderData?.note || '—'],
      ['Archivo', order.fileName || '—']
    ];
    info.innerHTML = infoPairs.map(([label,value])=>`
      <div class="info-card">
        <span class="info-label">${label}</span>
        <span class="info-value">${safe(value)}</span>
      </div>
    `).join('');

    const items = Array.isArray(order.orderData?.items)
      ? order.orderData.items
      : Array.isArray(order.doc?.cart?.items)
        ? order.doc.cart.items
        : Array.isArray(order.doc?.cart)
          ? order.doc.cart
          : [];
    itemsTable.innerHTML='';
    if (items.length){
      items.forEach(item=>{
        const tr=document.createElement('tr');
        const productName = item.name || item.product?.name || 'Producto';
        const sku = item.product?.sku || item.barcode || '';
        const qty = item.qty ?? item.quantity ?? 0;
        const price = item.final_price ?? item.price ?? item.price_incl_tax ?? item.total;
        const priceFormatted = item.final_price_currency_formatted || item.price_currency_formatted || fmtMoney(price);
        const total = item.total ?? item.total_incl_tax ?? (Number(price)*Number(qty));
        const totalFormatted = item.total_currency_formatted || item.total_incl_tax_currency_formatted || fmtMoney(total);
        const discount = toAmount(item.final_discount_amount ?? item.discount_amount ?? item.discount ?? 0);
        const discountFormatted =
          item.final_discount_amount_currency_formatted ||
          item.discount_amount_currency_formatted ||
          (discount ? fmtMoney(discount) : '0,00');
        tr.innerHTML = `<td>${safe(productName)}</td><td>${safe(sku)}</td><td>${safe(qty)}</td><td>${safe(priceFormatted)}</td><td>${safe(discountFormatted)}</td><td>${safe(totalFormatted)}</td>`;
        itemsTable.appendChild(tr);
      });
    } else {
      const tr=document.createElement('tr');
      tr.innerHTML = '<td colspan="6" class="muted">Sin productos</td>';
      itemsTable.appendChild(tr);
    }

    payTable.innerHTML='';
    if (order.payments.length){
      const seen = new Set();
      order.payments.forEach(p=>{
        const key = `${p.label}|${p.display}|${p.changeDisplay}|${p.reference}|${p.type}`;
        if(seen.has(key)) return;
        seen.add(key);
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${safe(p.label)}</td><td>${safe(p.display)}</td><td>${safe(p.changeDisplay || '0,00')}</td><td>${safe(p.reference)}</td><td>${safe(p.type)}</td>`;
        payTable.appendChild(tr);
      });
    } else {
      const tr=document.createElement('tr');
      tr.innerHTML = '<td colspan="5" class="muted">Sin pagos registrados</td>';
      payTable.appendChild(tr);
    }

    totals.innerHTML='';
    const totalsObj = order.totals || {};
    const totalsPairs = [
      ['Subtotal', totalsObj.sub_total ?? order.orderData?.sub_total, totalsObj.currency?.sub_total],
      ['Impuestos', totalsObj.tax_amount ?? order.orderData?.tax_amount, totalsObj.currency?.tax_amount],
      ['Descuento', totalsObj.discount_amount ?? order.orderData?.total_discount, totalsObj.currency?.discount_amount],
      ['Total', totalsObj.grand_total ?? order.orderData?.grand_total, totalsObj.currency?.grand_total],
      ['Pagado', totalsObj.total_paid ?? order.orderData?.total_paid, totalsObj.currency?.total_paid],
      ['Saldo', totalsObj.remain_paid ?? order.orderData?.remain_paid, totalsObj.currency?.remain_paid]
    ];
    totalsPairs.forEach(([label,value,currencyFormat])=>{
      const dt=document.createElement('dt'); dt.textContent = label;
      const dd=document.createElement('dd'); dd.textContent = fmtMoney(value, currencyFormat) || '—';
      totals.appendChild(dt); totals.appendChild(dd);
    });

    raw.textContent = JSON.stringify(order.doc, null, 2);
    detail.style.display = 'flex';
    $('#detail').removeAttribute('hidden');
  }

  function hideDetail(){ const d=$('#detail'); d.style.display='none'; d.setAttribute('hidden',''); }

  $('#detail-close').addEventListener('click', hideDetail);
  $('#detail').addEventListener('click', e=>{ if(e.target === $('#detail')) hideDetail(); });

  const ordersContainer = $('#orders');
  ordersContainer.addEventListener('click', e=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    const order = orders.find(o=>o.id === id);
    if(!order) return;
    if(action === 'detail') {
      fillDetail(order);
    } else if(btn.classList.contains('action-verify')) {
      order.status = 'verificado';
      if (order.doc && typeof order.doc === 'object') {
        order.doc.status = order.status;
      }
      alert(`Orden ${order.orderNumber || order.id} verificada.`);
      renderGroups();
      buildSummary();
    }
  });

  document.addEventListener('click', e=>{
    const btn = e.target.closest('.action-generate');
    if(!btn) return;
    e.preventDefault();
    if (!orders.length) {
      alert('No hay órdenes para verificar.');
      return;
    }
    orders.forEach(order => {
      order.status = 'verificado';
      if (order.doc) order.doc.status = order.status;
    });
    alert('Verificación general completada.');
    renderGroups();
    buildSummary();
  });

  function toCSV(list){
    const head = ['Cajero','Factura','Cliente','Total','Descuento','Métodos de pago','Fecha','Status','Archivo'];
    const lines = [head.join(',')];
    list.forEach(o=>{
      const payments = o.payments.map(p=>`${p.label} ${p.display}`).join(' | ');
      lines.push([
        o.cashier,
        o.orderNumber,
        o.customerName,
        o.totalDisplay || fmtMoney(o.total),
        o.discountDisplay || fmtMoney(o.discountAmount),
        payments,
        o.createdAtDisplay || o.createdAt,
        o.status || 'sin sinc.',
        o.fileName
      ].map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(','));
    });
    return lines.join('\n');
  }

  async function pickFolder(){
    if(!('showDirectoryPicker' in window)){
      alert('Tu navegador no soporta File System Access. Usa Chrome/Edge en desktop.');
      return;
    }
    try{
      folder = await showDirectoryPicker({mode:'read'});
      $('#info').textContent = 'Carpeta: ' + (folder.name || '(día)');
      orders=[];

      for await (const entry of folder.values()){
        if(entry.kind!=='file' || !entry.name.endsWith('.json')) continue;
        const file=await entry.getFile();
        const txt=await file.text();
        let doc=null; try{doc=JSON.parse(txt);}catch{continue;}
        try{
          const order = normalizeOrder(doc);
          orders.push(order);
        }catch(err){
          console.warn('No se pudo normalizar archivo', entry.name, err);
        }
      }
      buildSummary();
      renderGroups();
    }catch(e){
      console.warn(e); folder=null;
      $('#info').textContent = 'Sin carpeta';
    }
  }

  $('#open').onclick = pickFolder;
  $('#export').onclick = ()=>{
    const csv = toCSV(orders);
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download='csfx_cierre_'+new Date().toISOString().slice(0,10)+'.csv';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove()}, 600);
  };
  $('#print').onclick = ()=>window.print();
})();
</script>
</body>
</html>
